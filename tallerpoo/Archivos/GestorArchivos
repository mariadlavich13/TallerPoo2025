package tallerpoo.archivos;

import java.io.*;
import java.util.*;
import tallerpoo.clases.Auto;
import tallerpoo.clases.Escuderia;
import tallerpoo.clases.Carrera;
import tallerpoo.clases.Circuito;
import tallerpoo.clases.Mecanico;
import tallerpoo.clases.Piloto;
import tallerpoo.clases.Pais;
import tallerpoo.clases.ResultadoCarrera;
import tallerpoo.logica.LogicaException;

public class GestorArchivos{

    //LEER PAISES DESDE CSV
    public static List<Pais> leerPaisesDesdeCSV(String path) {
        List<Pais> paises = new ArrayList<>();
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado (ej: "idPais,descripcion")

            while ((linea = br.readLine()) != null) {
                String[] valores = linea.split(",");
                
                int idPais = Integer.parseInt(valores[0].trim());
                String descripcion = valores[1].trim();

                // Usamos el constructor que inicializa las listas vacías
                // (Basado en tu clase Pais)
                Pais p = new Pais(idPais, descripcion, new ArrayList<>(), new ArrayList<>(), new ArrayList<>(), new ArrayList<>());
                paises.add(p);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return paises;
    }

    //Helper para buscar un Pais por ID
    private static Pais buscarPaisPorId(List<Pais> paises, int id) {
    for (Pais p : paises) {
        if (p.getIdPais() == id) {
            return p;
        }
    }
    return null;
    }

    //Helper para buscar un Circuito por Nombre
    private static Circuito buscarCircuitoPorNombre(List<Circuito> circuitos, String nombre) {
    for (Circuito c : circuitos) {
        if (c.getNombre().equalsIgnoreCase(nombre.trim())) {
            return c;
        }
    }
    return null;
    }


    //Helper para buscar Escuderia por nombre
    private static Escuderia buscarEscuderiaPorNombre(List<Escuderia> escuderias, String nombre) {
        for (Escuderia e : escuderias) {
            if (e.getNombre().equalsIgnoreCase(nombre.trim())) {
                return e;
            }
        }
        return null;
    }
    //Helper para buscar Mecánico por DNI
private static Mecanico buscarMecanicoPorDni(List<Mecanico> mecanicos, String dni) {
    for (Mecanico m : mecanicos) {
        if (m.getDni().equals(dni.trim())) {
            return m;
        }
    }
    return null;
}
// Helper para buscar Piloto por DNI
    private static Piloto buscarPilotoPorDni(List<Piloto> pilotos, String dni) {
        for (Piloto p : pilotos) {
            if (p.getDni().equals(dni.trim())) {
                return p;
            }
        }
        return null;
    }

    // Helper para buscar Carrera por Fecha
    private static Carrera buscarCarreraPorFecha(List<Carrera> carreras, String fecha) {
        for (Carrera c : carreras) {
            if (c.getFechaRealizacion().equals(fecha.trim())) {
                return c;
            }
        }
        return null;
    }

    //LEER AUTOS DESDE CSV
    public static List<Auto> leerAutosDesdeCSV(String path, List<Escuderia> escuderias) { //ACEPTA ESCUDERIAS
        List<Auto> autos = new ArrayList<>();
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado

            while ((linea = br.readLine()) != null) {
                String[] valores = linea.split(",");
                String modelo = valores[0].trim();
                String motor = valores[1].trim();
                String nombreEscuderia = valores[2].trim(); // LEE LA NUEVA COLUMNA

                Auto a = new Auto(modelo, motor);
                
                // Busca la escudería
                Escuderia escuderiaAsignada = buscarEscuderiaPorNombre(escuderias, nombreEscuderia);

                if (escuderiaAsignada != null) {
                    // Aquí establecemos la relación en AMBAS direcciones
                    // Esto usa tus métodos agregarAuto(a) y setEscuderia(this)
                    escuderiaAsignada.agregarAuto(a);
                }
                
                autos.add(a);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return autos;
    }

    //LEER CIRCUITO DESDE CSV
    public static List<Circuito> leerCircuitosDesdeCSV(String path, List<Pais> paises) { // <--- Acepta la lista de Países
        List<Circuito> circuitos = new ArrayList<>();
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            br.readLine(); // Saltear encabezado

            while ((linea = br.readLine()) != null) {
                String[] valores = linea.split(",");
                String nombre = valores[0];
                double longitud = Double.parseDouble(valores[1].trim());
                int idPais = Integer.parseInt(valores[2].trim()); // <-- Lee el nuevo ID

                // Busca el objeto Pais
                Pais paisAsignado = buscarPaisPorId(paises, idPais);

                // Crea el objeto con el País real, no con null
                Circuito c = new Circuito(nombre, longitud, paisAsignado);
                circuitos.add(c);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return circuitos;
    }


    //LEER CARRERA DESDE CSV
    public static List<Carrera> leerCarrerasDesdeCSV(String path, List<Circuito> todosLosCircuitos) { // <--- Acepta la lista de Circuitos
        List<Carrera> carreras = new ArrayList<>();
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            br.readLine(); // Saltear encabezado

            while ((linea = br.readLine()) != null) {
                String[] valores = linea.split(",");
                String fechaRealizacion = valores[0];
                int nroVueltas = Integer.parseInt(valores[1].trim());
                String horaRealizacion = valores[2];
                String nombreCircuito = valores[3]; // <-- Lee el nombre del circuito

                // Busca el objeto Circuito
                Circuito circuitoAsignado = buscarCircuitoPorNombre(todosLosCircuitos, nombreCircuito);

                // Saca el país desde el circuito
                Pais paisAsignado = (circuitoAsignado != null) ? circuitoAsignado.getPais() : null;

                // Crea la Carrera con los objetos reales
                Carrera c = new Carrera(fechaRealizacion, nroVueltas, horaRealizacion, paisAsignado, circuitoAsignado);
                carreras.add(c);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return carreras;
    }

    //LEER ESCUDERIAS DESDE CSV
    public static List<Escuderia> leerEscuderiasDesdeCSV(String path) {
        List<Escuderia> escuderias = new ArrayList<>();

        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado

            while ((linea = br.readLine()) != null) {
                String[] valores = linea.split(",");

                String nombre = valores[0];

                Escuderia e = new Escuderia(nombre);
                escuderias.add(e);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return escuderias;
    }

    //LEER MECANICOS DESDE CSV
    // Acepta la lista de países para poder buscar y asignar el objeto correcto
    public static List<Mecanico> leerMecanicosDesdeCSV(String path, List<Pais> paises) {
        List<Mecanico> mecanicos = new ArrayList<>();
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado

            while ((linea = br.readLine()) != null) {
                String[] valores = linea.split(",");
                String dni = valores[0].trim();
                String nombre = valores[1].trim();
                String apellido = valores[2].trim();
                
                // 1. Lee el ID del país (en lugar de un String)
                int idPais = Integer.parseInt(valores[3].trim()); 
                
                Especialidad esp = Especialidad.valueOf(valores[4].trim());
                int aniosExperiencia = Integer.parseInt(valores[5].trim());

                // 2. Busca el objeto Pais usando el helper
                Pais paisAsignado = buscarPaisPorId(paises, idPais);

                // 3. Pasa el objeto Pais al constructor
                Mecanico m = new Mecanico(dni, nombre, apellido, paisAsignado, esp, aniosExperiencia, new ArrayList<>());
                mecanicos.add(m);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return mecanicos;
    }

    //LEER PILOTOS DESDE CSV
    // Acepta la lista de países
    public static List<Piloto> leerPilotosDesdeCSV(String path, List<Pais> paises) {
        List<Piloto> pilotos = new ArrayList<>();
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado

            while ((linea = br.readLine()) != null) {
                // Asegúrate de que tu CSV tenga la columna extra para el idPais
                String[] valores = linea.split(",");
                
                // Evita líneas vacías o corruptas
                if (valores.length < 9) continue; 
                
                String dni = valores[0].trim();
                String nombre = valores[1].trim();
                String apellido = valores[2].trim();
                
                // 1. Lee el ID del país (asumiendo que es la 4ta columna)
                int idPais = Integer.parseInt(valores[3].trim()); 
                
                int numeroCompetencia = Integer.parseInt(valores[4].trim());
                int victorias = Integer.parseInt(valores[5].trim());
                int polePosition = Integer.parseInt(valores[6].trim());
                int vueltasRapidas = Integer.parseInt(valores[7].trim());
                int podios = Integer.parseInt(valores[8].trim());

                // 2. Busca el objeto Pais
                Pais paisAsignado = buscarPaisPorId(paises, idPais);

                Piloto p = new Piloto(dni, nombre, apellido, paisAsignado, numeroCompetencia, victorias, polePosition, vueltasRapidas, podios);

                pilotos.add(p);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return pilotos;
    }
    /**
    *Lee el archivo de unión M-N y vincula los objetos.
    */
    public static void vincularMecanicosAEscuderias(String path, List<Mecanico> todosLosMecanicos, List<Escuderia> todasLasEscuderias) {

        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado

        while ((linea = br.readLine()) != null) {
            String[] valores = linea.split(",");
            String dniMecanico = valores[0].trim();
            String nombreEscuderia = valores[1].trim();

            Mecanico mecanico = buscarMecanicoPorDni(todosLosMecanicos, dniMecanico);
            Escuderia escuderia = buscarEscuderiaPorNombre(todasLasEscuderias, nombreEscuderia);

            if (mecanico != null && escuderia != null) {
                mecanico.agregarEscuderia(escuderia); //
                escuderia.agregarMecanico(mecanico); //
            }
        }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    /**
     * Escribe un nuevo resultado de carrera al final del archivo CSV.
     * Usa 'true' en FileWriter para modo "append" (añadir).
     *
     * @param path La ruta al archivo DatosResultadoCarrera.csv
     * @param resultado El objeto ResultadoCarrera a guardar.
     */
    public static void escribirResultadoCSV(String path, ResultadoCarrera resultado) {
        // Usamos try-with-resources para asegurarnos de que el writer se cierre
        try (FileWriter fw = new FileWriter(path, true); // <-- El 'true' es para AÑADIR (append)
            BufferedWriter bw = new BufferedWriter(fw);
            PrintWriter out = new PrintWriter(bw))
        {
            // Formato: dni_piloto, fecha_carrera, posicion
            String linea = resultado.getPiloto().getDni() + "," +
                        resultado.getCarrera().getFechaRealizacion() + "," +
                        resultado.getPosicion();
            
            out.println(linea); // Escribe la nueva línea

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

/**
     * Lee los resultados desde el CSV.
     * LANZA LogicaException si el archivo no se encuentra, está corrupto
     * o si un DNI o fecha de carrera no se encuentra.
     */
    public static List<ResultadoCarrera> leerResultadosDesdeCSV(String path, List<Piloto> pilotos, List<Carrera> carreras)
            throws LogicaException { //Declarar que puede lanzar la excepción

        List<ResultadoCarrera> resultados = new ArrayList<>();
        int nroLinea = 1; //Añadir contador de línea para errores claros

        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) {
                    nroLinea++;
                    continue;
                }

                String[] valores = linea.split(",");
                if (valores.length < 3) {
                    //Lanzar excepción en lugar de 'continue'
                    throw new LogicaException("Error en DatosResultadoCarrera.csv (Línea " + nroLinea + "): La línea está incompleta.");
                }

                String dniPiloto = valores[0].trim();
                String fechaCarrera = valores[1].trim();
                int posicion;

                //Try-catch específico para el número
                try {
                    posicion = Integer.parseInt(valores[2].trim());
                } catch (NumberFormatException e) {
                    throw new LogicaException("Error en DatosResultadoCarrera.csv (Línea " + nroLinea + "): La posición '" + valores[2].trim() + "' no es un número.");
                }

                Piloto pilotoAsignado = buscarPilotoPorDni(pilotos, dniPiloto);
                Carrera carreraAsignada = buscarCarreraPorFecha(carreras, fechaCarrera);

                //Lanzar excepción si no se encuentran los datos
                if (pilotoAsignado == null) {
                    throw new LogicaException("Error en DatosResultadoCarrera.csv (Línea " + nroLinea + "): No se encontró el piloto con DNI " + dniPiloto);
                }
                if (carreraAsignada == null) {
                    throw new LogicaException("Error en DatosResultadoCarrera.csv (Línea " + nroLinea + "): No se encontró la carrera con fecha " + fechaCarrera);
                }
                
                ResultadoCarrera res = new ResultadoCarrera(pilotoAsignado, posicion, carreraAsignada);
                resultados.add(res);
                nroLinea++; // Incrementar al final del bucle
            }
        } catch (IOException e) {
            //Capturar la IOException y lanzarla como LogicaException
            throw new LogicaException("Error al leer el archivo " + path + ": " + e.getMessage());
        }
        return resultados;
    }
}
