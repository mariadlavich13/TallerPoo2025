package tallerpoo.archivos;

import java.io.*;
import java.util.*;
import tallerpoo.clases.Auto;
import tallerpoo.clases.Escuderia;
import tallerpoo.clases.Carrera;
import tallerpoo.clases.Circuito;
import tallerpoo.clases.Mecanico;
import tallerpoo.clases.Piloto;
import tallerpoo.clases.Pais;
import tallerpoo.clases.ResultadoCarrera;
import tallerpoo.clases.Especialidad; // Importa Especialidad
import tallerpoo.logica.LogicaException;

/**
 * Clase de utilidad estática para manejar la lectura y escritura
 * de los archivos CSV (Capa de Persistencia).
 * Convierte líneas de texto de CSV en objetos de las 'clases' y viceversa.
 */
public class GestorArchivos {

    // --- MÉTODOS HELPER (Buscadores) ---

    /**
     * Busca un Pais por su ID en una lista.
     * @param paises Lista de Países.
     * @param id ID a buscar.
     * @return El Pais encontrado, o null.
     */
    private static Pais buscarPaisPorId(List<Pais> paises, int id) {
        for (Pais p : paises) {
            if (p.getIdPais() == id) {
                return p;
            }
        }
        return null;
    }

    /**
     * Busca un Circuito por su nombre en una lista.
     * @param circuitos Lista de Circuitos.
     * @param nombre Nombre a buscar (ignora mayúsculas/minúsculas).
     * @return El Circuito encontrado, o null.
     */
    private static Circuito buscarCircuitoPorNombre(List<Circuito> circuitos, String nombre) {
        for (Circuito c : circuitos) {
            if (c.getNombre().equalsIgnoreCase(nombre.trim())) {
                return c;
            }
        }
        return null;
    }

    /**
     * Busca una Escuderia por su nombre en una lista.
     * @param escuderias Lista de Escuderias.
     * @param nombre Nombre a buscar (ignora mayúsculas/minúsculas).
     * @return La Escuderia encontrada, o null.
     */
    private static Escuderia buscarEscuderiaPorNombre(List<Escuderia> escuderias, String nombre) {
        for (Escuderia e : escuderias) {
            if (e.getNombre().equalsIgnoreCase(nombre.trim())) {
                return e;
            }
        }
        return null;
    }

    /**
     * Busca un Mecánico por su DNI en una lista.
     * @param mecanicos Lista de Mecanicos.
     * @param dni DNI a buscar.
     * @return El Mecanico encontrado, o null.
     */
    private static Mecanico buscarMecanicoPorDni(List<Mecanico> mecanicos, String dni) {
        for (Mecanico m : mecanicos) {
            if (m.getDni().equals(dni.trim())) {
                return m;
            }
        }
        return null;
    }

    /**
     * Busca un Piloto por su DNI en una lista.
     * @param pilotos Lista de Pilotos.
     * @param dni DNI a buscar.
     * @return El Piloto encontrado, o null.
     */
    private static Piloto buscarPilotoPorDni(List<Piloto> pilotos, String dni) {
        for (Piloto p : pilotos) {
            if (p.getDni().equals(dni.trim())) {
                return p;
            }
        }
        return null;
    }

    /**
     * Busca una Carrera por su fecha en una lista.
     * @param carreras Lista de Carreras.
     * @param fecha Fecha a buscar.
     * @return La Carrera encontrada, o null.
     */
    private static Carrera buscarCarreraPorFecha(List<Carrera> carreras, String fecha) {
        for (Carrera c : carreras) {
            if (c.getFechaRealizacion().equals(fecha.trim())) {
                return c;
            }
        }
        return null;
    }

    // --- MÉTODOS DE LECTURA (CSV a Objetos) ---

    /**
     * Lee el archivo "DatosPaises.csv".
     * @param path Ruta al archivo.
     * @return Lista de objetos Pais.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<Pais> leerPaisesDesdeCSV(String path) throws LogicaException {
        List<Pais> paises = new ArrayList<>();
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 2) throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Línea incompleta.");
                
                try {
                    int idPais = Integer.parseInt(valores[0].trim());
                    String descripcion = valores[1].trim();
                    Pais p = new Pais(idPais, descripcion, new ArrayList<>(), new ArrayList<>(), new ArrayList<>(), new ArrayList<>());
                    paises.add(p);
                    nroLinea++;
                } catch (NumberFormatException e) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): ID de país no es un número.");
                }
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
        return paises;
    }

    /**
     * Lee el archivo "DatosAutos.csv".
     * @param path Ruta al archivo.
     * @param escuderias Lista de escuderías para asignar la relación.
     * @return Lista de objetos Auto.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<Auto> leerAutosDesdeCSV(String path, List<Escuderia> escuderias) throws LogicaException {
        List<Auto> autos = new ArrayList<>();
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 3) throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Línea incompleta.");

                String modelo = valores[0].trim();
                String motor = valores[1].trim();
                String nombreEscuderia = valores[2].trim();

                Auto a = new Auto(modelo, motor);
                Escuderia escuderiaAsignada = buscarEscuderiaPorNombre(escuderias, nombreEscuderia);
                
                if (escuderiaAsignada == null) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró la escudería '" + nombreEscuderia + "'.");
                }
                
                escuderiaAsignada.agregarAuto(a); // Establece relación bidireccional
                autos.add(a);
                nroLinea++;
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
        return autos;
    }

    /**
     * Lee el archivo "DatosCircuitos.csv".
     * @param path Ruta al archivo.
     * @param paises Lista de países para asignar la relación.
     * @return Lista de objetos Circuito.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<Circuito> leerCircuitosDesdeCSV(String path, List<Pais> paises) throws LogicaException {
        List<Circuito> circuitos = new ArrayList<>();
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            br.readLine(); // Saltear encabezado
            nroLinea++;
            String linea;
            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 3) throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Línea incompleta.");

                try {
                    String nombre = valores[0].trim();
                    double longitud = Double.parseDouble(valores[1].trim());
                    int idPais = Integer.parseInt(valores[2].trim());

                    Pais paisAsignado = buscarPaisPorId(paises, idPais);
                    if (paisAsignado == null) {
                        throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró el país con ID " + idPais);
                    }
                    
                    Circuito c = new Circuito(nombre, longitud, paisAsignado);
                    circuitos.add(c);
                    nroLinea++;
                } catch (NumberFormatException e) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Longitud o ID de país no son números válidos.");
                }
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
        return circuitos;
    }

    /**
     * Lee el archivo "DatosCarreras.csv".
     * @param path Ruta al archivo.
     * @param todosLosCircuitos Lista de circuitos para asignar la relación.
     * @return Lista de objetos Carrera.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<Carrera> leerCarrerasDesdeCSV(String path, List<Circuito> todosLosCircuitos) throws LogicaException {
        List<Carrera> carreras = new ArrayList<>();
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            br.readLine(); // Saltear encabezado
            nroLinea++;
            String linea;
            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 4) throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Línea incompleta.");

                try {
                    String fechaRealizacion = valores[0].trim();
                    int nroVueltas = Integer.parseInt(valores[1].trim());
                    String horaRealizacion = valores[2].trim();
                    String nombreCircuito = valores[3].trim();

                    Circuito circuitoAsignado = buscarCircuitoPorNombre(todosLosCircuitos, nombreCircuito);
                    if (circuitoAsignado == null) {
                        throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró el circuito '" + nombreCircuito + "'.");
                    }

                    Pais paisAsignado = circuitoAsignado.getPais();
                    Carrera c = new Carrera(fechaRealizacion, nroVueltas, horaRealizacion, paisAsignado, circuitoAsignado);
                    carreras.add(c);
                    nroLinea++;
                } catch (NumberFormatException e) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Nro de vueltas no es un número.");
                }
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
        return carreras;
    }

    /**
     * Lee el archivo "DatosEscuderias.csv".
     * @param path Ruta al archivo.
     * @return Lista de objetos Escuderia.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<Escuderia> leerEscuderiasDesdeCSV(String path) throws LogicaException {
        List<Escuderia> escuderias = new ArrayList<>();
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 1) throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Línea incompleta.");

                String nombre = valores[0].trim();
                Escuderia e = new Escuderia(nombre);
                escuderias.add(e);
                nroLinea++;
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
        return escuderias;
    }

    /**
     * Lee el archivo "DatosMecanicos.csv".
     * @param path Ruta al archivo.
     * @param paises Lista de países para asignar la relación.
     * @return Lista de objetos Mecanico.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<Mecanico> leerMecanicosDesdeCSV(String path, List<Pais> paises) throws LogicaException {
        List<Mecanico> mecanicos = new ArrayList<>();
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 6) throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Línea incompleta.");

                try {
                    String dni = valores[0].trim();
                    String nombre = valores[1].trim();
                    String apellido = valores[2].trim();
                    int idPais = Integer.parseInt(valores[3].trim());
                    Especialidad esp = Especialidad.valueOf(valores[4].trim().toUpperCase()); // Convertir a mayúsculas
                    int aniosExperiencia = Integer.parseInt(valores[5].trim());

                    Pais paisAsignado = buscarPaisPorId(paises, idPais);
                    if (paisAsignado == null) {
                        throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró el país con ID " + idPais);
                    }
                    
                    Mecanico m = new Mecanico(dni, nombre, apellido, paisAsignado, esp, aniosExperiencia, new ArrayList<>());
                    mecanicos.add(m);
                    nroLinea++;
                } catch (NumberFormatException e) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): ID de país o Años de exp. no son números.");
                } catch (IllegalArgumentException e) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Especialidad '" + valores[4].trim() + "' no válida.");
                }
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
        return mecanicos;
    }

    /**
     * Lee el archivo "DatosPilotos.csv".
     * @param path Ruta al archivo.
     * @param paises Lista de países para asignar la relación.
     * @return Lista de objetos Piloto.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<Piloto> leerPilotosDesdeCSV(String path, List<Pais> paises) throws LogicaException {
        List<Piloto> pilotos = new ArrayList<>();
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 9) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): La línea está incompleta.");
                }

                try {
                    String dni = valores[0].trim();
                    String nombre = valores[1].trim();
                    String apellido = valores[2].trim();
                    int idPais = Integer.parseInt(valores[3].trim());
                    int numeroCompetencia = Integer.parseInt(valores[4].trim());
                    int victorias = Integer.parseInt(valores[5].trim());
                    int polePosition = Integer.parseInt(valores[6].trim());
                    int vueltasRapidas = Integer.parseInt(valores[7].trim());
                    int podios = Integer.parseInt(valores[8].trim());

                    Pais paisAsignado = buscarPaisPorId(paises, idPais);
                    if (paisAsignado == null) {
                        throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró el país con ID " + idPais);
                    }
                    
                    Piloto p = new Piloto(dni, nombre, apellido, paisAsignado, numeroCompetencia, victorias, polePosition, vueltasRapidas, podios);
                    pilotos.add(p);
                    nroLinea++;
                } catch (NumberFormatException e) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Dato numérico (ID, stats) inválido.");
                }
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
        return pilotos;
    }

    /**
     * Lee el archivo de unión "DatosMecanicoEscuderia.csv" y vincula las entidades.
     * @param path Ruta al archivo.
     * @param todosLosMecanicos Lista de todos los mecánicos.
     * @param todasLasEscuderias Lista de todas las escuderías.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static void vincularMecanicosAEscuderias(String path, List<Mecanico> todosLosMecanicos, List<Escuderia> todasLasEscuderias) throws LogicaException {
        int nroLinea = 1;
        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) { nroLinea++; continue; }
                String[] valores = linea.split(",");
                if (valores.length < 2) throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): Línea incompleta.");

                String dniMecanico = valores[0].trim();
                String nombreEscuderia = valores[1].trim();

                Mecanico mecanico = buscarMecanicoPorDni(todosLosMecanicos, dniMecanico);
                Escuderia escuderia = buscarEscuderiaPorNombre(todasLasEscuderias, nombreEscuderia);

                if (mecanico == null) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró el mecánico con DNI " + dniMecanico);
                }
                if (escuderia == null) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró la escudería '" + nombreEscuderia + "'.");
                }
                
                mecanico.agregarEscuderia(escuderia);
                escuderia.agregarMecanico(mecanico);
                nroLinea++;
            }
        } catch (IOException e) {
            throw new LogicaException("Error  al leer el archivo " + path + ": " + e.getMessage());
        }
    }

    /**
     * Escribe un nuevo resultado de carrera al final del archivo CSV (modo 'append').
     *
     * @param path La ruta al archivo "DatosResultadoCarrera.csv".
     * @param resultado El objeto ResultadoCarrera a guardar.
     * @throws LogicaException Si ocurre un error de E/S (IOException) al escribir.
     */
    public static void escribirResultadoCSV(String path, ResultadoCarrera resultado) throws LogicaException {
        // Usamos try-with-resources para asegurarnos de que el writer se cierre
        try (FileWriter fw = new FileWriter(path, true); // <-- El 'true' es para AÑADIR (append)
            BufferedWriter bw = new BufferedWriter(fw);
            PrintWriter out = new PrintWriter(bw))
        {
            // Formato: dni_piloto, fecha_carrera, posicion
            String linea = resultado.getPiloto().getDni() + "," +
                        resultado.getCarrera().getFechaRealizacion() + "," +
                        resultado.getPosicion();
            out.println(linea); // Escribe la nueva línea

        } catch (IOException e) {
            // Lanzamos LogicaException en lugar de e.printStackTrace()
            throw new LogicaException("Error al escribir en el archivo " + path + ": " + e.getMessage());
        }
    }

    /**
     * Lee el archivo "DatosResultadoCarrera.csv".
     * @param path Ruta al archivo.
     * @param pilotos Lista de pilotos para asignar la relación.
     * @param carreras Lista de carreras para asignar la relación.
     * @return Lista de objetos ResultadoCarrera.
     * @throws LogicaException Si el archivo no se encuentra o hay un error de formato.
     */
    public static List<ResultadoCarrera> leerResultadosDesdeCSV(String path, List<Piloto> pilotos, List<Carrera> carreras)
            throws LogicaException {

        List<ResultadoCarrera> resultados = new ArrayList<>();
        int nroLinea = 1;

        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String linea;
            br.readLine(); // Saltear encabezado
            nroLinea++;

            while ((linea = br.readLine()) != null) {
                if (linea.trim().isEmpty()) {
                    nroLinea++;
                    continue;
                }

                String[] valores = linea.split(",");
                if (valores.length < 3) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): La línea está incompleta.");
                }

                String dniPiloto = valores[0].trim();
                String fechaCarrera = valores[1].trim();
                int posicion;

                try {
                    posicion = Integer.parseInt(valores[2].trim());
                } catch (NumberFormatException e) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): La posición '" + valores[2].trim() + "' no es un número.");
                }

                Piloto pilotoAsignado = buscarPilotoPorDni(pilotos, dniPiloto);
                Carrera carreraAsignada = buscarCarreraPorFecha(carreras, fechaCarrera);

                if (pilotoAsignado == null) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró el piloto con DNI " + dniPiloto);
                }
                if (carreraAsignada == null) {
                    throw new LogicaException("Error en " + path + " (Línea " + nroLinea + "): No se encontró la carrera con fecha " + fechaCarrera);
                }
                
                ResultadoCarrera res = new ResultadoCarrera(pilotoAsignado, posicion, carreraAsignada);
                resultados.add(res);
                nroLinea++;
            }
        } catch (IOException e) {
            throw new LogicaException("Error al leer el archivo " + path + ": " + e.getMessage());
        }
        return resultados;
    }
}