package tallerpoo.logica;
import tallerpoo.SistemaGestion;
import tallerpoo.Piloto;
import tallerpoo.Auto;
import tallerpoo.Carrera;
import tallerpoo.AutoPiloto;
import tallerpoo.ResultadoCarrera;
import tallerpoo.archivos.GestorArchivos;
import tallerpoo.Puntaje;
import tallerpoo.Escuderia;
import tallerpoo.Mecanico;
import tallerpoo.PilotoEscuderia;

public class LogicaGestion {
    /**
    /**
     *Asocia piloto a auto en una carrera.
     * Verifica que no haya duplicados.
     * @return El objeto AutoPiloto creado si la asignación es exitosa.
     * @throws LogicaException Si el auto o el piloto ya están asignados en esa carrera.
     */
    public AutoPiloto asociarPilotoAutoACarrera(Carrera carrera, Piloto piloto, Auto auto, String fechaAsignacion) throws LogicaException {
        
        // Verifica que un auto no sea asignado a más de un piloto en la misma carrera
        for (AutoPiloto participante : carrera.getParticipantes()) {
            if (participante.getAuto().equals(auto)) {
                throw new LogicaException("El auto " + auto.getModelo() + " ya está asignado a otro piloto en esta carrera.");
            }
        }
        
        // Verifica que un piloto no esté asignado a más de un auto en la misma carrera
        for (AutoPiloto participante : carrera.getParticipantes()) {
            if (participante.getPiloto().equals(piloto)) {
                throw new LogicaException("El piloto " + piloto.getNombre() + " ya está participando con otro auto en esta carrera.");
            }
        }

        // Si pasa la verificación, crea la asociación
        AutoPiloto nuevaASociacion = new AutoPiloto(fechaAsignacion, piloto, auto, carrera);
        
        // Guarda la asignación en Persistencia
        carrera.agregarParticipante(nuevaASociacion);
        piloto.agregarAutoPiloto(nuevaASociacion);
        auto.agregarAutoPiloto(nuevaASociacion);
        
        return nuevaAsociacion; // Devolvemos el objeto creado
    }

    /**
     * Registra el resultado final de un piloto en una carrera.
     * Esto guarda el resultado y actualiza las estadísticas del piloto.
     *
     * @param datos El sistema de gestión con todas las listas.
     * @param carrera La carrera que finalizó.
     * @param piloto El piloto que obtuvo el resultado.
     * @param posicion La posición final (1, 2, 3...).
     * @param tuvoVueltaRapida true si este piloto hizo la vuelta rápida, false si no.
     */
    public void registrarResultado(SistemaGestion datos, Carrera carrera, Piloto piloto, int posicion, boolean tuvoVueltaRapida) throws LogicaException {
        
        // --- 1. Validaciones ---
        if (posicion < 1) {
            throw new LogicaException("La posición debe ser mayor o igual a 1.");
        } 
        // Validación: ¿El piloto realmente participó en la carrera?
        boolean participo = false;
        for (AutoPiloto ap : carrera.getParticipantes()) {
            if (ap.getPiloto().equals(piloto)) {
                participo = true;
                break;
            }
        }
        if (!participo) {
            throw new LogicaException("El piloto " + piloto.getNombre() + " no participó en esta carrera.");
        }
        
        // Validación: ¿Ya existe un resultado para este piloto en esta carrera?
        for (ResultadoCarrera r : datos.getResultados()) {
            if (r.getCarrera().equals(carrera) && r.getPiloto().equals(piloto)) {
                throw new LogicaException("El piloto " + piloto.getNombre() + " ya tiene un resultado registrado para esta carrera.");
            }
        }

        // --- 2. Crear y guardar el objeto resultado ---
        ResultadoCarrera resultado = new ResultadoCarrera(piloto, posicion, carrera);
        datos.agregarResultadoCarrera(resultado); 

        // --- 3. Actualizar estadísticas del Piloto ---
        if (posicion == 1) {
            piloto.setVictorias(piloto.getVictorias() + 1);
        }
        if (posicion <= 3) {
            piloto.setPodios(piloto.getPodios() + 1);
        }  
        if (tuvoVueltaRapida) {
            piloto.setVueltasRapidas(piloto.getVueltasRapidas() + 1);
        }

        // --- 4. Guardar en el archivo CSV ---
        String pathResultados = "Datos/DatosResultadoCarrera.csv";
        GestorArchivos.escribirResultadoCSV(pathResultados, resultado);
    }
    /**
     * Calcula el puntaje total de todos los pilotos basado en los resultados de todas las carreras.
     *
     * @param datos El objeto SistemaGestion que contiene todas las listas.
     * @return Una lista de objetos PilotoPuntaje, ordenada de mayor a menor puntaje.
     */
    public List<PilotoPuntaje> calcularPuntajes(SistemaGestion datos) {
        
        List<PilotoPuntaje> puntajesFinales = new ArrayList<>();
        List<Piloto> todosLosPilotos = datos.getPilotos();
        List<ResultadoCarrera> todosLosResultados = datos.getResultados();

        // Bucle exterior: Itera sobre cada piloto
        for (Piloto piloto : todosLosPilotos) {
            
            int puntajeTotalDelPiloto = 0; // Inicia el contador para este piloto

            // Bucle interior: Itera sobre todos los resultados de todas las carreras
            for (ResultadoCarrera resultado : todosLosResultados) {
                
                // Comprueba si el resultado pertenece al piloto actual
                // (Comparamos por DNI por seguridad)
                if (resultado.getPiloto().getDni().equals(piloto.getDni())) {
                    
                    // Obtiene los puntos para esa posición
                    int puntosObtenidos = Puntaje.obtenerPuntaje(resultado.getPosicion());
                    
                    // Los suma al total del piloto
                    puntajeTotalDelPiloto += puntosObtenidos;
                }
            }

            // Una vez contados todos los resultados, crea el objeto contenedor
            PilotoPuntaje pp = new PilotoPuntaje(piloto, puntajeTotalDelPiloto);
            puntajesFinales.add(pp);
        }

        // Una vez que tenemos la lista con todos los pilotos y sus puntajes,
        // la ordenamos usando el método compareTo que definimos en PilotoPuntaje.
        Collections.sort(puntajesFinales);

        return puntajesFinales;
    }
}